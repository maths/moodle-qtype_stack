{"version":3,"file":"edityaml.min.js","sources":["../src/edityaml.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to allow editing of PRTs in YAML format.\n *\n * @module     qtype_stack/edityaml\n * @copyright  2025 The University of Edinburgh\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as yaml from 'qtype_stack/js-yaml-lazy';\n\nexport const setup = () => {\n    const inputElement = document.querySelector('#id_yamlinput');\n    if (!inputElement) {\n        return;\n    }\n    if (!inputElement.value) {\n        yamlRevert();\n    } else {\n        if (inputElement.value != yamlParse()) {\n            changeCallback();\n        } else {\n            inputElement.addEventListener('input', changeCallback);\n        }\n    }\n    document.querySelector('#id_stack-revert-yaml')?.addEventListener('click', yamlRevert);\n    document.querySelector('#id_stack-convert-yaml')?.addEventListener('click', yamlConvert);\n};\n\n/**\n * Set up the change callback to warn about unsaved changes.\n */\nfunction changeCallback() {\n    const errorDiv = document.querySelector('#fgroup_id_error_yamlbuttons');\n    if (errorDiv) {\n        errorDiv.style.display = 'block';\n        errorDiv.innerHTML = getTranslation('yamlwarning');\n    }\n    document.querySelector('#id_yamlinput')?.removeEventListener('input', changeCallback);\n}\n\n/**\n * Set up the change callback to warn about unsaved changes.\n */\nfunction changeRemove() {\n    const errorDiv = document.querySelector('#fgroup_id_error_yamlbuttons');\n    if (errorDiv) {\n        errorDiv.style.display = 'none';\n        errorDiv.innerHTML = '';\n    }\n    document.querySelector('#id_yamlinput')?.addEventListener('input', changeCallback);\n}\n\n/**\n * Copy original YAML of PRTs from hidden field to the text edit area.\n */\nfunction yamlRevert() {\n    const inputElement = document.querySelector('#id_yamlinput');\n    if (!inputElement) {\n        return;\n    }\n    let yamltext;\n    try {\n        yamltext = yamlParse();\n    } catch (e) {\n        yamltext = '';\n    }\n    inputElement.value = yamltext;\n    changeRemove();\n}\n\n/**\n *\n * @returns {string} YAML representation of the PRTs.\n */\nfunction yamlParse() {\n    const json = document.querySelector('input[name=\"stack-yamloriginal\"]')?.value;\n    if (!json) {\n        return '';\n    }\n    let prtsObject;\n    try {\n        prtsObject = JSON.parse(json);\n    } catch (e) {\n        return '';\n    }\n\n    Object.values(prtsObject).forEach(prt => {\n        delete prt.name;\n        delete prt.id;\n        delete prt.questionid;\n        delete prt.firstnodename;\n        if (prt.nodes) {\n            prt.nodes.forEach(node => {\n                delete node.id;\n                delete node.questionid;\n                delete node.prtname;\n            });\n        }\n    });\n    try {\n        return yaml.dump(prtsObject, { lineWidth: -1 });\n    } catch (e) {\n        return '';\n    }\n}\n\n/**\n *\n * @param {*} key\n * @returns\n */\nfunction getTranslation(key) {\n    const transElement = document.querySelector('input[name=\"stack-yamltranslations\"]');\n    if (!transElement) {\n        return '';\n    }\n    let json = transElement.value;\n    if (!json) {\n        return '';\n    }\n    try {\n        json = JSON.parse(json);\n    } catch (e) {\n        return '';\n    }\n    return json[key] ?? '';\n}\n\n/**\n * Convert YAML in the text area to an object and put the values in the PRT fields.\n */\nfunction yamlConvert() {\n    const yamltext = document.querySelector('#id_yamlinput')?.value;\n    const errorDiv = document.querySelector('#id_error_yamlinput');\n    if (!errorDiv) {\n        return;\n    }\n    errorDiv.innerHTML = '';\n    errorDiv.style.display = 'none';\n    let isError = false;\n\n    let prtsObject;\n    try {\n        prtsObject = yaml.load(yamltext);\n    } catch (e) {\n        errorDiv.innerHTML += getTranslation('yamlerror') + ': ' + e.message + '<br>';\n        errorDiv.style.display = 'block';\n        return;\n    }\n\n    for (const prtkey in prtsObject) {\n        if (!document.querySelector('#id_' + prtkey + 'prtheader')) {\n            // No such PRT in the form.\n            errorDiv.innerHTML += getTranslation('yamlprtwarning') + ' ' + prtkey + '<br>';\n            errorDiv.style.display = 'block';\n            isError = true;\n            continue;\n        }\n        const currentPrt = prtsObject[prtkey];\n        if (currentPrt.nodes ) {\n            for (const currentNode of currentPrt.nodes) {\n                // Would need to submit add node multiple times to sort this automatically.\n                // We would still run into issues if the node naming in the YAML was dubious.\n                const nodeKey = currentNode.nodename;\n                if (!document.querySelector('#id_' + prtkey + 'description' + '_' + nodeKey)) {\n                    errorDiv.innerHTML += getTranslation('yamlnodewarning') + ' ' + prtkey + ' - ' + nodeKey + '<br>';\n                    errorDiv.style.display = 'block';\n                    isError = true;\n                }\n            }\n        }\n    }\n    if (isError) {\n        return;\n    }\n    for (const prtkey in prtsObject) {\n        const currentPrt = prtsObject[prtkey];\n        if ('value' in currentPrt ?? document.querySelector('#id_' + prtkey + 'value')) {\n            document.querySelector('#id_' + prtkey + 'value').value = currentPrt.value;\n        }\n        if ('autosimplify' in currentPrt && document.querySelector('#id_' + prtkey + 'autosimplify')) {\n            document.querySelector('#id_' + prtkey + 'autosimplify').value = currentPrt.autosimplify;\n        }\n        if ('feedbackstyle' in currentPrt && document.querySelector('#id_' + prtkey + 'feedbackstyle')) {\n            document.querySelector('#id_' + prtkey + 'feedbackstyle').value = currentPrt.feedbackstyle;\n        }\n        if ('feedbackvariables' in currentPrt && document.querySelector('#id_' + prtkey + 'feedbackvariables')) {\n            document.querySelector('#id_' + prtkey + 'feedbackvariables').value = currentPrt.feedbackvariables;\n        }\n        if (!currentPrt.nodes) {\n            continue;\n        }\n        for (const currentNode of currentPrt.nodes) {\n            const nodeKey = currentNode.nodename;\n            if ('description' in currentNode && document.querySelector('#id_' + prtkey + 'description' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'description' + '_' + nodeKey).value = currentNode.description;\n            }\n            if ('answertest' in currentNode && document.querySelector('#id_' + prtkey + 'answertest' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'answertest' + '_' + nodeKey).value = currentNode.answertest;\n            }\n            if ('sans' in currentNode && document.querySelector('#id_' + prtkey + 'sans' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'sans' + '_' + nodeKey).value = currentNode.sans;\n            }\n            if ('tans' in currentNode && document.querySelector('#id_' + prtkey + 'tans' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'tans' + '_' + nodeKey).value = currentNode.tans;\n            }\n            if ('testoptions' in currentNode && document.querySelector('#id_' + prtkey + 'testoptions' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'testoptions' + '_' + nodeKey).value = currentNode.testoptions;\n            }\n            if ('quiet' in currentNode && document.querySelector('#id_' + prtkey + 'quiet' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'quiet' + '_' + nodeKey).value = currentNode.quiet;\n            }\n            if ('truescoremode' in currentNode && document.querySelector('#id_' + prtkey + 'truescoremode' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'truescoremode' + '_' + nodeKey).value = currentNode.truescoremode;\n            }\n            if ('truescore' in currentNode && document.querySelector('#id_' + prtkey + 'truescore' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'truescore' + '_' + nodeKey).value = currentNode.truescore;\n            }\n            if ('truepenalty' in currentNode && document.querySelector('#id_' + prtkey + 'truepenalty' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'truepenalty' + '_' + nodeKey).value = currentNode.truepenalty;\n            }\n            if ('truenextnode' in currentNode && document.querySelector('#id_' + prtkey + 'truenextnode' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'truenextnode' + '_' + nodeKey).value = currentNode.truenextnode;\n            }\n            if ('trueanswernote' in currentNode && document.querySelector('#id_' + prtkey + 'trueanswernote' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'trueanswernote' + '_' + nodeKey).value = currentNode.trueanswernote;\n            }\n            if ('truefeedback' in currentNode) {\n                if (document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey + 'editable')) {\n                    document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey + 'editable').value\n                        = currentNode.truefeedback;\n                } else if (document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey)) {\n                    document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey).value\n                        = currentNode.truefeedback;\n                }\n            }\n            if ('truefeedbackformat' in currentNode\n                    && document.querySelector('#id_' + prtkey + 'truefeedbackformat' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'truefeedbackformat' + '_' + nodeKey).value\n                        = currentNode.truefeedbackformat;\n            }\n            if ('falsescoremode' in currentNode && document.querySelector('#id_' + prtkey + 'falsescoremode' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falsescoremode' + '_' + nodeKey).value = currentNode.falsescoremode;\n            }\n            if ('falsescore' in currentNode && document.querySelector('#id_' + prtkey + 'falsescore' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falsescore' + '_' + nodeKey).value = currentNode.falsescore;\n            }\n            if ('falsepenalty' in currentNode && document.querySelector('#id_' + prtkey + 'falsepenalty' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falsepenalty' + '_' + nodeKey).value = currentNode.falsepenalty;\n            }\n            if ('falsenextnode' in currentNode && document.querySelector('#id_' + prtkey + 'falsenextnode' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falsenextnode' + '_' + nodeKey).value = currentNode.falsenextnode;\n            }\n            if ('falseanswernote' in currentNode && document.querySelector('#id_' + prtkey + 'falseanswernote' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falseanswernote' + '_' + nodeKey).value = currentNode.falseanswernote;\n            }\n            if ('falsefeedback' in currentNode) {\n                if (document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey + 'editable')) {\n                    document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey + 'editable').value\n                        = currentNode.falsefeedback;\n                } else if (document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey)) {\n                    document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey).value\n                        = currentNode.falsefeedback;\n                }\n            }\n            if ('falsefeedbackformat' in currentNode\n                    && document.querySelector('#id_' + prtkey + 'falsefeedbackformat' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falsefeedbackformat' + '_' + nodeKey).value\n                        = currentNode.falsefeedbackformat;\n            }\n        }\n    }\n}\n"],"names":["changeCallback","errorDiv","document","querySelector","style","display","innerHTML","getTranslation","removeEventListener","yamlRevert","inputElement","yamltext","yamlParse","e","value","addEventListener","changeRemove","json","_document$querySelect5","prtsObject","JSON","parse","Object","values","forEach","prt","name","id","questionid","firstnodename","nodes","node","prtname","yaml","dump","lineWidth","key","transElement","yamlConvert","_document$querySelect6","isError","load","message","prtkey","currentPrt","currentNode","nodeKey","nodename","autosimplify","feedbackstyle","feedbackvariables","description","answertest","sans","tans","testoptions","quiet","truescoremode","truescore","truepenalty","truenextnode","trueanswernote","truefeedback","truefeedbackformat","falsescoremode","falsescore","falsepenalty","falsenextnode","falseanswernote","falsefeedback","falsefeedbackformat"],"mappings":"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"}