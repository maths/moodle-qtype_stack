{"version":3,"file":"edityaml.min.js","sources":["../src/edityaml.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to allow editing of PRTs in YAML format.\n *\n * @module     qtype_stack/edityaml\n * @copyright  2025 The University of Edinburgh\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as yaml from 'qtype_stack/js-yaml-lazy';\n\nexport const setup = () => {\n    if (!document.querySelector('#id_yamlinput').value) {\n        yamlRevert();\n    } else {\n        if (document.querySelector('#id_yamlinput').value != yamlParse()) {\n            changeCallback();\n        } else {\n            document.querySelector('#id_yamlinput').addEventListener('change', changeCallback);\n        }\n    }\n    document.querySelector('#id_stack-revert-yaml').addEventListener('click', yamlRevert);\n    document.querySelector('#id_stack-convert-yaml').addEventListener('click', yamlConvert);\n};\n\n/**\n * Set up the change callback to warn about unsaved changes.\n */\nfunction changeCallback() {\n    document.querySelector('#id_updatebutton').addEventListener('mousedown', yamlChanged);\n    document.querySelector('#id_submitbutton').addEventListener('mousedown', yamlChanged);\n    document.querySelector('#id_yamlinput').removeEventListener('change', changeCallback);\n}\n\n/**\n * Set up the change callback to warn about unsaved changes.\n */\nfunction changeRemove() {\n    document.querySelector('#id_updatebutton').removeEventListener('mousedown', yamlChanged);\n    document.querySelector('#id_submitbutton').removeEventListener('mousedown', yamlChanged);\n    document.querySelector('#id_yamlinput').addEventListener('change', changeCallback);\n}\n\n/**\n * Copy original YAML of PRTs from hidden field to the text edit area.\n */\nfunction yamlRevert() {\n    let yamltext = yamlParse();\n    document.querySelector('#id_yamlinput').value = yamltext;\n    changeRemove();\n}\n\n/**\n *\n * @returns {string} YAML representation of the PRTs.\n */\nfunction yamlParse() {\n    let json = document.querySelector('input[name=\"stack-yamloriginal\"]').value;\n    let prtsObject = JSON.parse(json);\n    Object.values(prtsObject).forEach(prt => {\n        delete prt.name;\n        delete prt.id;\n        delete prt.questionid;\n        delete prt.firstnodename;\n        prt.nodes.forEach(node => {\n            delete node.id;\n            delete node.questionid;\n            delete node.prtname;\n        });\n    });\n\n    return yaml.dump(prtsObject, { lineWidth: -1 });\n}\n\n/**\n *\n * @param {*} event\n */\nfunction yamlChanged(event) {\n    event.preventDefault();\n    event.returnValue = '';\n}\n\n/**\n * Convert YAML in the text area to an object and put the values in the PRT fields.\n */\nfunction yamlConvert() {\n    let yamltext = document.querySelector('#id_yamlinput').value;\n    let prtsObject = yaml.load(yamltext);\n    const errorDiv = document.querySelector('#id_error_yamlinput');\n    errorDiv.innerHTML = '';\n    errorDiv.style.display = 'none';\n    let isError = false;\n    for (const prtkey in prtsObject) {\n        if (!document.querySelector('#id_' + prtkey + 'prtheader')) {\n            // No such PRT in the form.\n            // How to translate this?\n            errorDiv.innerHTML += 'No such PRT: ' + prtkey + '<br>';\n            errorDiv.style.display = 'block';\n            isError = true;\n            continue;\n        }\n        const currentPrt = prtsObject[prtkey];\n        for (const currentNode of currentPrt.nodes) {\n            // Would need to submit add node multiple times to sort this automatically.\n            // We would still run into issues if the node naming in the YAML was dubious.\n            const nodeKey = currentNode.nodename;\n            if (!document.querySelector('#id_' + prtkey + 'description' + '_' + nodeKey)) {\n                errorDiv.innerHTML += 'No such node: PRT: ' + prtkey + ' Node: ' + nodeKey + '<br>';\n                errorDiv.style.display = 'block';\n                isError = true;\n            }\n        }\n    }\n    if (isError) {\n        return;\n    }\n    for (const prtkey in prtsObject) {\n        const currentPrt = prtsObject[prtkey];\n        if ('value' in currentPrt) {\n            document.querySelector('#id_' + prtkey + 'value').value = currentPrt.value;\n        }\n        if ('autosimplify' in currentPrt) {\n            document.querySelector('#id_' + prtkey + 'autosimplify').value = currentPrt.autosimplify;\n        }\n        if ('feedbackstyle' in currentPrt) {\n            document.querySelector('#id_' + prtkey + 'feedbackstyle').value = currentPrt.feedbackstyle;\n        }\n        if ('feedbackvariables' in currentPrt) {\n            document.querySelector('#id_' + prtkey + 'feedbackvariables').value = currentPrt.feedbackvariables;\n        }\n        for (const currentNode of currentPrt.nodes) {\n            const nodeKey = currentNode.nodename;\n            if ('description' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'description' + '_' + nodeKey).value = currentNode.description;\n            }\n            if ('answertest' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'answertest' + '_' + nodeKey).value = currentNode.answertest;\n            }\n            if ('sans' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'sans' + '_' + nodeKey).value = currentNode.sans;\n            }\n            if ('tans' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'tans' + '_' + nodeKey).value = currentNode.tans;\n            }\n            if ('testoptions' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'testoptions' + '_' + nodeKey).value = currentNode.testoptions;\n            }\n            if ('quiet' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'quiet' + '_' + nodeKey).value = currentNode.quiet;\n            }\n            if ('truescoremode' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'truescoremode' + '_' + nodeKey).value = currentNode.truescoremode;\n            }\n            if ('truescore' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'truescore' + '_' + nodeKey).value = currentNode.truescore;\n            }\n            if ('truepenalty' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'truepenalty' + '_' + nodeKey).value = currentNode.truepenalty;\n            }\n            if ('truenextnode' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'truenextnode' + '_' + nodeKey).value = currentNode.truenextnode;\n            }\n            if ('trueanswernote' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'trueanswernote' + '_' + nodeKey).value = currentNode.trueanswernote;\n            }\n            if ('truefeedback' in currentNode) {\n                if (document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey + 'editable')) {\n                    document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey + 'editable').value\n                        = currentNode.truefeedback;\n                } else if (document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey)) {\n                    document.querySelector('#id_' + prtkey + 'truefeedback' + '_' + nodeKey).value\n                        = currentNode.truefeedback;\n                }\n            }\n            if ('truefeedbackformat' in currentNode\n                    && document.querySelector('#id_' + prtkey + 'truefeedbackformat' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'truefeedbackformat' + '_' + nodeKey).value\n                        = currentNode.truefeedbackformat;\n            }\n            if ('falsescoremode' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'falsescoremode' + '_' + nodeKey).value = currentNode.falsescoremode;\n            }\n            if ('falsescore' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'falsescore' + '_' + nodeKey).value = currentNode.falsescore;\n            }\n            if ('falsepenalty' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'falsepenalty' + '_' + nodeKey).value = currentNode.falsepenalty;\n            }\n            if ('falsenextnode' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'falsenextnode' + '_' + nodeKey).value = currentNode.falsenextnode;\n            }\n            if ('falseanswernote' in currentNode) {\n                document.querySelector('#id_' + prtkey + 'falseanswernote' + '_' + nodeKey).value = currentNode.falseanswernote;\n            }\n            if ('falsefeedback' in currentNode) {\n                if (document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey + 'editable')) {\n                    document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey + 'editable').value\n                        = currentNode.falsefeedback;\n                } else if (document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey)) {\n                    document.querySelector('#id_' + prtkey + 'falsefeedback' + '_' + nodeKey).value\n                        = currentNode.falsefeedback;\n                }\n            }\n            if ('falsefeedbackformat' in currentNode\n                    && document.querySelector('#id_' + prtkey + 'falsefeedbackformat' + '_' + nodeKey)) {\n                document.querySelector('#id_' + prtkey + 'falsefeedbackformat' + '_' + nodeKey).value\n                        = currentNode.falsefeedbackformat;\n            }\n        }\n    }\n    changeRemove();\n}\n"],"names":["changeCallback","document","querySelector","addEventListener","yamlChanged","removeEventListener","changeRemove","yamlRevert","yamltext","yamlParse","value","json","prtsObject","JSON","parse","Object","values","forEach","prt","name","id","questionid","firstnodename","nodes","node","prtname","yaml","dump","lineWidth","event","preventDefault","returnValue","yamlConvert","load","errorDiv","innerHTML","style","display","isError","prtkey","currentPrt","currentNode","nodeKey","nodename","autosimplify","feedbackstyle","feedbackvariables","description","answertest","sans","tans","testoptions","quiet","truescoremode","truescore","truepenalty","truenextnode","trueanswernote","truefeedback","truefeedbackformat","falsescoremode","falsescore","falsepenalty","falsenextnode","falseanswernote","falsefeedback","falsefeedbackformat"],"mappings":"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"}