{"version":3,"file":"library.min.js","sources":["../src/library.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to handle requests for library question info\n * and to import questions.\n *\n * @module     qtype_stack/library\n * @copyright  2024 The University of Edinburgh\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'core/ajax',\n    'core_filters/events'\n], function(\n    Ajax,\n    CustomEvents\n) {\n\n    let courseId = null;\n    let categoryId = null;\n    let libraryDiv = null;\n    let rawDiv = null;\n    let variablesDiv = null;\n    let descriptionDiv = null;\n    let importListDiv = null;\n    let importSuccessDiv = null;\n    let importFailureDiv = null;\n    let importSuccessFileDiv = null;\n    let importFailureFileDiv = null;\n    let displayedDiv = null;\n    let quizLink = null;\n    let dashLink = null;\n    let errorDiv = null;\n    let errorDetailsDiv = null;\n    let currentPath = null;\n\n    /**\n     * Sets up event listeners.\n     *\n     */\n    function setup() {\n        libraryDiv = document.querySelector('.stack_library_display');\n        rawDiv = document.querySelector('.stack_library_raw_display');\n        variablesDiv = document.querySelector('.stack_library_variables_display');\n        importListDiv = document.querySelector('.stack-library-imported-list');\n        displayedDiv = document.querySelector('.stack_library_selected_question');\n        descriptionDiv = document.querySelector('.stack_library_description_display');\n        errorDiv = document.querySelector('.stack-library-error');\n        errorDetailsDiv = document.querySelector('.stack-library-error-details');\n        importSuccessDiv = document.querySelector('.stack-library-import-success');\n        importFailureDiv = document.querySelector('.stack-library-import-failure');\n        importSuccessFileDiv = document.querySelector('.stack-library-import-success-file');\n        importFailureFileDiv = document.querySelector('.stack-library-import-failure-file');\n        dashLink = document.querySelector('#dashboard-link-holder').innerHTML.trim();\n        quizLink = document.querySelector('#quiz-link-holder').innerHTML.trim();\n        dashLink = dashLink.includes('?') ? dashLink = dashLink + '&questionid=' : dashLink = dashLink + '?questionid=';\n        loading(true);\n        const linksArray = document.querySelectorAll('.library-file-link');\n        linksArray.forEach(function(elem) {\n            elem.addEventListener('click', libraryRender);\n        });\n        courseId = document.querySelector('[data-id=\"stack_library_course_id\"]').getAttribute('data-value');\n        const importButton = document.querySelector('.library-import-link');\n        importButton.addEventListener('click', ()=>libraryImport(false));\n        const importFolderButton = document.querySelector('.library-import-link-folder');\n        importFolderButton.addEventListener('click', ()=>libraryImport(true));\n        // Remove number of questions from category dropdown as we're not\n        // updating them and that will confuse users.\n        const catOptions = document.querySelectorAll('#id_category option');\n        for (let option of catOptions) {\n            let optionText = option.text;\n            const sections = optionText.split('(');\n            if (sections.length > 1) {\n                if (sections[0] || sections.length > 2) {\n                    sections.pop();\n                    option.text = sections.join('(');\n                }\n            }\n        }\n        loading(false);\n    }\n\n    /**\n     * Performs AJAX call to Moodle to get info on a question when\n     * a link containing the questions filename is clicked.\n     *\n     * @param {object} e the click event triggering the function call.\n     */\n    function libraryRender(e) {\n        const filepath = e.target.getAttribute('data-filepath');\n        currentPath = filepath;\n        loading(true);\n        categoryId = Number(document.getElementById('id_category').value.split(',')[0]);\n        Ajax.call([{\n            methodname: 'qtype_stack_library_render',\n            args: {category: categoryId, filepath: filepath},\n            done: function(response) {\n                loading(false);\n                libraryDiv.innerHTML = response.questionrender;\n                for (const iframe of response.iframes) {\n                    require(['qtype_stack/stackjsvle'],\n                        function(stackjsvle,) {\n                            stackjsvle.create_iframe(\n                                iframe.iframeid,\n                                iframe.content,\n                                iframe.targetdivid,\n                                iframe.title,\n                                iframe.scrolling,\n                                iframe.evil\n                            );\n                        });\n                  }\n                rawDiv.innerText = response.questiontext;\n                descriptionDiv.innerHTML = response.questiondescription;\n                variablesDiv.innerHTML = response.questionvariables.replace(/;/g, \";<br>\");\n                displayedDiv.innerHTML = response.questionname + '<br>(' + filepath.split('/').pop() + ')';\n                document.querySelectorAll('.library-secondary-info')\n                    .forEach(el => el.removeAttribute('hidden'));\n                document.querySelector('.library-import-link').removeAttribute('disabled');\n                if (filepath.endsWith('_quiz.json')) {\n                    document.querySelector('.stack-library-category-holder').setAttribute('hidden', true);\n                    document.querySelector('.stack-library-course').removeAttribute('hidden');\n                } else {\n                    document.querySelector('.stack-library-course').setAttribute('hidden', true);\n                    document.querySelector('.stack-library-category-holder').removeAttribute('hidden');\n                    document.querySelector('.library-import-link-folder').removeAttribute('disabled');\n                }\n                // This fires the Maths filters for content in the validation div.\n                CustomEvents.notifyFilterContentUpdated(libraryDiv);\n            },\n            fail: function(response) {\n                loading(false);\n                errorDetailsDiv.innerHTML = (response.message) ? response.message : '';\n                errorDiv.hidden = false;\n            }\n        }]);\n    }\n\n    /**\n     * Performs AJAX call to Moodle to import a question.\n     *\n     * @param {boolean} isFolder is this a request to load the whole folder\n     */\n    function libraryImport(isFolder) {\n        if (!currentPath) {\n            return;\n        }\n        const filepath = currentPath;\n        loading(true);\n        categoryId = Number(document.getElementById('id_category').value.split(',')[0]);\n        Ajax.call([{\n            methodname: 'qtype_stack_library_import',\n            args: {courseid: courseId, category: categoryId, filepath: filepath, isfolder: (isFolder) ? 1 : 0},\n            done: function(response) {\n                loading(false);\n                for (const currentQuestion of response) {\n                    if (currentQuestion.success) {\n                        let currentDashLink = dashLink + currentQuestion.questionid;\n                        if (currentQuestion.isstack) {\n                            importListDiv.innerHTML += '<br>' + '<a target=\"_blank\" href=\"'\n                                + currentDashLink + '\">' + currentQuestion.questionname + '</a>';\n                        } else if (currentQuestion.filename.endsWith('_quiz.json')) {\n                            importListDiv.innerHTML += '<br>' + '<a target=\"_blank\" href=\"'\n                                + quizLink + '?id=' + currentQuestion.questionid + '\">'\n                                + currentQuestion.questionname + '</a>';\n                        } else {\n                            importListDiv.innerHTML += '<br>' + currentQuestion.questionname;\n                        }\n                        importSuccessFileDiv.innerHTML += '<br>' +\n                            currentQuestion.filename.split('/').pop() + ' --> ' + currentQuestion.questionname;\n                        importSuccessDiv.removeAttribute('hidden');\n                    } else {\n                        importFailureFileDiv.innerHTML += '<br>' +\n                            currentQuestion.filename.split('/').pop();\n                        importFailureDiv.removeAttribute('hidden');\n                    }\n                }\n            },\n            fail: function(response) {\n                loading(false);\n                errorDetailsDiv.innerHTML = (response.message) ? response.message : '';\n                errorDiv.hidden = false;\n            }\n        }]);\n    }\n\n    /**\n     * Disable/enable features before/after loading.\n     *\n     * @param {boolean} isLoading Is an AJAX call taking place?\n     */\n    function loading(isLoading) {\n        errorDiv.hidden = true;\n        if (isLoading) {\n            document.querySelector('.loading-display').removeAttribute('hidden');\n            document.querySelector('.library-import-link').setAttribute('disabled', 'disabled');\n            document.querySelector('.library-import-link-folder').setAttribute('disabled', 'disabled');\n            document.querySelectorAll('.library-file-link').forEach(el => el.setAttribute('disabled', 'disabled'));\n            importSuccessFileDiv.innerHTML = '';\n            importSuccessDiv.setAttribute('hidden', true);\n            importFailureFileDiv.innerHTML = '';\n            importFailureDiv.setAttribute('hidden', true);\n        } else {\n            document.querySelector('.loading-display').setAttribute('hidden', true);\n            document.querySelectorAll('.library-file-link').forEach(el => el.removeAttribute('disabled'));\n        }\n    }\n\n    /** Export our entry point. */\n    return {\n        setup: setup\n    };\n});\n"],"names":["define","Ajax","CustomEvents","courseId","categoryId","libraryDiv","rawDiv","variablesDiv","descriptionDiv","importListDiv","importSuccessDiv","importFailureDiv","importSuccessFileDiv","importFailureFileDiv","displayedDiv","quizLink","dashLink","errorDiv","errorDetailsDiv","currentPath","libraryRender","e","filepath","target","getAttribute","loading","Number","document","getElementById","value","split","call","methodname","args","category","done","response","innerHTML","questionrender","iframe","iframes","require","stackjsvle","create_iframe","iframeid","content","targetdivid","title","scrolling","evil","innerText","questiontext","questiondescription","questionvariables","replace","questionname","pop","querySelectorAll","forEach","el","removeAttribute","querySelector","endsWith","setAttribute","notifyFilterContentUpdated","fail","message","hidden","libraryImport","isFolder","courseid","isfolder","currentQuestion","success","currentDashLink","questionid","isstack","filename","isLoading","setup","trim","includes","elem","addEventListener","catOptions","option","sections","text","length","join"],"mappings":"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"}