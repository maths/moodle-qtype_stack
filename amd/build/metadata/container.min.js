define("qtype_stack/metadata/container",["exports","core/reactive","qtype_stack/metadata/metadata","core_form/events"],(function(_exports,_reactive,_metadata,_events){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;
/**
   * Main STACK metadata component
   *
   * @module     qtype_stack/metadata
   * @copyright  2025 University of Edinburgh
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later.
   */
class _default extends _reactive.BaseComponent{create(){this.name="stack-metadata-container",this.selectors={METADATACONTAINER:"[data-for='qtype-stack-metadata']",UPDATEJSON:"#stack-metadata-update",UPDATEINPUTS:"#stack-metadata-update-inputs",ADDITEM:'[name="smd_add"]',DELETEITEM:'[name="smd_delete"]',MAKECONTRIBUTOR:"#stack-metadata-make-contributor",MAKECREATOR:"#stack-metadata-make-creator",REVERT:"#stack-metadata-revert"},_metadata.metadata.container=this}static init(target,selectors){return new this({element:document.querySelector(target),reactive:_metadata.metadata,selectors:selectors})}async stateReady(state){await this.reloadContainerComponent({state:state})}getWatchers(){return[{watch:"state:updated",handler:this.reloadContainerComponent}]}createDataElement(required,id,tag,value){return{required:required,element:{value:value,wrapperid:"fitem_smdi_"+id+"_"+tag,id:"smdi_"+id+"_"+tag,name:"smdi_"+id+"_"+tag}}}async reloadContainerComponent(_ref){let{state:state}=_ref;const data={creator:{},contributor:[],language:[],license:this.createDataElement(!0,0,"license_value",state.license.value),isPartOf:this.createDataElement(!1,0,"isPartOf_value",state.isPartOf.value),scope:[]};data.license.element.options=JSON.parse(JSON.stringify(_metadata.metadata.lib.licenses));const selectedLicense=state.license.value;let selectedOption=data.license.element.options.find((op=>op.value===selectedLicense));selectedOption?selectedOption.selected=!0:data.license.element.options.push({value:state.license.value,text:state.license.value,selected:!0}),data.license.element.tags="[]",data.license.element.ajax="",data.license.element.placeholder=_metadata.metadata.lib.placeholder,data.license.element.noselectionstring="",data.license.element.showsuggestions="true",data.license.element.casesensitive="false",state.language.forEach((language=>{const element={id:language.id,lang:this.createDataElement(!0,language.id,"language_value",language.value)};data.language.push({...element})})),state.contributor.forEach((contributor=>{const element={firstname:this.createDataElement(!1,contributor.id,"contributor_firstName",contributor.firstName),lastname:this.createDataElement(!0,contributor.id,"contributor_lastName",contributor.lastName),institution:this.createDataElement(!1,contributor.id,"contributor_institution",contributor.institution),year:this.createDataElement(!1,contributor.id,"contributor_year",contributor.year),id:contributor.id};data.contributor.push({...element})}));const scopeHolder={};state.additional.forEach((additional=>{const element={property:this.createDataElement(!0,additional.id,"additional_property",additional.property),qualifier:this.createDataElement(!1,additional.id,"additional_qualifier",additional.qualifier),value:this.createDataElement(!1,additional.id,"additional_value",additional.value),id:additional.id};scopeHolder[additional.scope]||(scopeHolder[additional.scope]=[]),scopeHolder[additional.scope].push(element)}));for(const scope in scopeHolder){const current={name:scope,firstProp:scopeHolder[scope][0].id,properties:scopeHolder[scope],input:this.createDataElement(!0,scopeHolder[scope][0].id,"additional_scope",scope)};data.scope.push(current)}data.creator={firstname:this.createDataElement(!1,0,"creator_firstName",state.creator.firstName),lastname:this.createDataElement(!0,0,"creator_lastName",state.creator.lastName),institution:this.createDataElement(!1,0,"creator_institution",state.creator.institution),year:this.createDataElement(!1,0,"creator_year",state.creator.year)},data.json={required:!0,element:{value:JSON.stringify(state,_metadata.metadata.replacer,4),attributes:'rows="10"',wrapperid:"fitem_metadata_json",id:"id_metadata_json",name:"metadata_json"}};const metadataContainer=this.getElement(this.selectors.METADATACONTAINER);if(!metadataContainer)throw new Error("Missing metadata container.");await this.renderComponent(metadataContainer,"qtype_stack/metadata/metadatacontent",data),this.addEventListener(this.getElement(this.selectors.UPDATEJSON),"click",this.update);const addButtons=this.getElements(this.selectors.ADDITEM);for(const addButton of addButtons)this.addEventListener(addButton,"click",this.addItem);const deleteButtons=this.getElements(this.selectors.DELETEITEM);for(const deleteButton of deleteButtons)this.addEventListener(deleteButton,"click",this.deleteItem);this.addEventListener(this.getElement(this.selectors.UPDATEINPUTS),"click",this.updateInputs),this.addEventListener(this.getElement(this.selectors.MAKECREATOR),"click",this.makeCreator),this.addEventListener(this.getElement(this.selectors.MAKECONTRIBUTOR),"click",this.makeContributor),this.addEventListener(this.getElement(this.selectors.REVERT),"click",this.revert)}async update(){if(!(arguments.length>0&&void 0!==arguments[0])||arguments[0]){const requiredElements=this.getElements('#qtype-stack-metadata-content input[aria-required="true"]');let isError=!1;for(const element of requiredElements)""===element.value?(isError=!0,(0,_events.notifyFieldValidationFailure)(element,"Required")):element.classList.contains("is-invalid")&&(0,_events.notifyFieldValidationFailure)(element,"");if(isError)return!1}let inputElements=this.getElements('#qtype-stack-metadata-content [id^="smdi"]');inputElements=Array.from(inputElements).map((el=>[el.id,el.value]));const scopeElements=inputElements.filter((el=>"scope"===el[0].split("_")[4])),propertyElements=inputElements.filter((el=>"property"===el[0].split("_")[4]));let currentScope=null;for(let i=1;i<=propertyElements.length;i++){let scopeMatch=scopeElements.find((el=>el[0].split("_")[2]===i));scopeMatch?currentScope=scopeMatch:inputElements.push(["smdi_"+i+"_additional_scope",currentScope])}return await this.reactive.dispatch("updateAll",inputElements),!0}async addItem(event){if(await this.update(!1)){const parts=event.target.id.split("_");this.reactive.dispatch("addItem",parts[1],parts[2])}}async deleteItem(event){if(await this.update(!1)){const parts=event.target.id.split("_");this.reactive.dispatch("deleteRow",parts[1],parts[2])}}updateInputs(){const jsonElement=this.getElement("#id_metadata_json");let data=null;try{data=_metadata.metadata.jsonToState(jsonElement.value),(0,_events.notifyFieldValidationFailure)(jsonElement,"")}catch(e){return void(0,_events.notifyFieldValidationFailure)(jsonElement,e.message)}jsonElement.value=JSON.stringify(data,_metadata.metadata.replacer,4),this.reactive.dispatch("updateFromJson",data)}async makeContributor(){await this.update(!1)&&this.reactive.dispatch("addItem","contributor","user")}makeCreator(){this.getElement("#smdi_0_creator_firstName").value=_metadata.metadata.lib.user.firstname,this.getElement("#smdi_0_creator_lastName").value=_metadata.metadata.lib.user.lastname,this.getElement("#smdi_0_creator_institution").value=_metadata.metadata.lib.user.institution,this.getElement("#smdi_0_creator_year").value=(new Date).getFullYear()}revert(){const jsonElement=this.getElement("#id_metadata_json");let previousdata=document.querySelector('input[name="metadata"]');try{var _previousdata;previousdata=_metadata.metadata.jsonToState(null===(_previousdata=previousdata)||void 0===_previousdata?void 0:_previousdata.value),(0,_events.notifyFieldValidationFailure)(jsonElement,"")}catch(e){return(0,_events.notifyFieldValidationFailure)(jsonElement,e.message),void(jsonElement.value=previousdata)}jsonElement.value=JSON.stringify(previousdata,_metadata.metadata.replacer,4),this.reactive.dispatch("updateFromJson",previousdata)}}return _exports.default=_default,_exports.default}));

//# sourceMappingURL=container.min.js.map