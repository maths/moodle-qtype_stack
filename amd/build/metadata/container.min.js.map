{"version":3,"file":"container.min.js","sources":["../../src/metadata/container.js"],"sourcesContent":["// This file is part of Stack - http://stack.maths.ed.ac.uk/\n//\n// Stack is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Stack is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Stack.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main STACK metadata component\n *\n * @module     qtype_stack/metadata\n * @copyright  2025 University of Edinburgh\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later.\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport {metadata} from 'qtype_stack/metadata/metadata';\nimport {notifyFieldValidationFailure} from 'core_form/events';\n\nexport default class extends BaseComponent {\n    create() {\n        this.name = 'stack-metadata-container';\n        this.selectors = {\n            METADATACONTAINER: `[data-for='qtype-stack-metadata']`,\n            UPDATEJSON: `#stack-metadata-update`,\n            UPDATEINPUTS: `#stack-metadata-update-inputs`,\n            ADDITEM: `[name=\"smd_add\"]`,\n        };\n        metadata.container = this;\n    }\n\n    /**\n     * Static method to create a component instance form the mustache template.\n     *\n     * @param {string} target the DOM main element or its ID\n     * @param {object} selectors optional css selector overrides\n     * @return {Component}\n     */\n    static init(target, selectors) {\n        return new this({\n            element: document.querySelector(target),\n            reactive: metadata,\n            selectors,\n        });\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * @param {object} state the initial state\n     */\n    async stateReady(state) {\n        await this.reloadContainerComponent({state});\n    }\n\n    getWatchers() {\n        return [\n            {watch: `state:updated`, handler: this.reloadContainerComponent},\n        ];\n    }\n\n    createDataElement(required, id, tag, value) {\n        return {\n            required: required,\n            element: {\n                value: value,\n                wrapperid: 'fitem_smdi_' + id + '_' + tag,\n                id: 'smdi_' + id + '_' + tag,\n                name: 'smdi_' + id + '_' + tag,\n            }\n        };\n    }\n\n    async reloadContainerComponent({state}) {\n        // Mustache data is not fully compatible with state object so we need to convert it\n        // into a plain object.\n        const data = {\n            creator: {},\n            contributor: [],\n            language: [],\n            license: this.createDataElement(true, 0, 'license_value', state.license.value),\n            isPartOf: this.createDataElement(false, 0, 'isPartOf_value', state.isPartOf.value),\n            scope: [],\n        };\n        data.license.element.options = JSON.parse(JSON.stringify(metadata.lib.licenses));\n        const selectedLicense = state.license.value;\n        let selectedOption = data.license.element.options.find((op) => op.value === selectedLicense);\n        if (selectedOption) {\n            selectedOption.selected = true;\n        } else {\n            data.license.element.options.push({value: state.license.value, text: state.license.value, selected: true});\n        }\n        data.license.element.tags = '[]';\n        data.license.element.ajax = '';\n        data.license.element.placeholder = '';\n        data.license.element.noselectionstring = '';\n        data.license.element.showsuggestions = 'true';\n        data.license.element.casesensitive = 'false';\n        state.language.forEach(language => {\n            const element = { id: language.id, lang: this.createDataElement(true, language.id, 'language_value', language.value) };\n            data.language.push({...element});\n        });\n        state.contributor.forEach(contributor => {\n             const element = {\n                firstname: this.createDataElement(false, contributor.id, 'contributor_firstName', contributor.firstName),\n                lastname: this.createDataElement(true, contributor.id, 'contributor_lastName', contributor.lastName),\n                institution: this.createDataElement(false, contributor.id, 'contributor_institution', contributor.institution),\n                year: this.createDataElement(false, contributor.id, 'contributor_year', contributor.year),\n                id: contributor.id,\n            };\n            data.contributor.push({...element});\n        });\n        const scopeHolder = {};\n        state.additional.forEach(additional => {\n            const element = {\n                property: this.createDataElement(true, additional.id, 'additional_property', additional.property),\n                qualifier: this.createDataElement(false, additional.id, 'additional_qualifier', additional.qualifier),\n                value: this.createDataElement(false, additional.id, 'additional_value', additional.value),\n                id: additional.id,\n            };\n            if (!scopeHolder[additional.scope]) {\n                scopeHolder[additional.scope] = [];\n            }\n            scopeHolder[additional.scope].push(element);\n        });\n        for (const scope in scopeHolder) {\n            const current = {\n                name: scope,\n                firstProp: scopeHolder[scope][0].id,\n                properties: scopeHolder[scope],\n                input: this.createDataElement(true, scopeHolder[scope][0].id, 'additional_scope', scope)\n            };\n            data.scope.push(current);\n        }\n        data.creator = {\n            firstname: this.createDataElement(false, 0, 'creator_firstName', state.creator.firstName),\n            lastname: this.createDataElement(true, 0, 'creator_lastName', state.creator.lastName),\n            institution: this.createDataElement(false, 0, 'creator_institution', state.creator.institution),\n            year: this.createDataElement(false, 0, 'creator_year', state.creator.year),\n        };\n        data.json = {\n            required: true,\n            element: {\n                value: JSON.stringify(state, metadata.replacer, 4),\n                attributes: 'rows=\"10\"',\n                wrapperid: 'fitem_metadata_json',\n                id: 'id_metadata_json',\n                name: 'metadata_json',\n            }\n        };\n\n        document.querySelector('input[name=\"metadata\"]').value = JSON.stringify(state, metadata.replacer);\n        // To render a child component we need a container.\n        const metadataContainer = this.getElement(this.selectors.METADATACONTAINER);\n        if (!metadataContainer) {\n            throw new Error('Missing metadata container.');\n        }\n\n        await this.renderComponent(metadataContainer, 'qtype_stack/metadatacontent', data);\n        this.addEventListener(\n            this.getElement(this.selectors.UPDATEJSON),\n            'click',\n            this.update\n        );\n        const addButtons = this.getElements(this.selectors.ADDITEM);\n        for (const addButton of addButtons) {\n            this.addEventListener(\n                addButton,\n                'click',\n                this.addItem\n            );\n        }\n        this.addEventListener(\n            this.getElement(this.selectors.UPDATEINPUTS),\n            'click',\n            this.updateInputs\n        );\n    }\n\n    /**\n     * Our submit handler.\n     *\n     */\n    async update() {\n        const requiredElements = this.getElements('#qtype-stack-metadata-content input[aria-required=\"true\"]');\n        let isError = false;\n        for (const element of requiredElements) {\n            if (element.value === '') {\n                isError = true;\n                notifyFieldValidationFailure(element, 'Required');\n            } else if (element.classList.contains('is-invalid')) {\n                // Reset as no longer empty.\n                notifyFieldValidationFailure(element, '');\n            }\n        }\n        if (isError) {\n            return false;\n        }\n        let inputElements = this.getElements('#qtype-stack-metadata-content [id^=\"smdi\"]');\n        inputElements = Array.from(inputElements).map((el) => [el.id, el.value]);\n        const scopeElements = inputElements.filter((el) => el[0].split('_')[4] === 'scope');\n        const propertyElements = inputElements.filter((el) => el[0].split('_')[4] === 'property');\n        let currentScope = null;\n        for (let i=1; i <= propertyElements.length; i++) {\n            let scopeMatch = scopeElements.find((el) => el[0].split('_')[2] === i);\n            if (scopeMatch) {\n                currentScope = scopeMatch;\n            } else {\n                inputElements.push(['smdi_' + i + '_additional_scope', currentScope]);\n            }\n        }\n        await this.reactive.dispatch('updateAll', inputElements);\n        return true;\n    }\n\n    addItem(event) {\n        const parts = event.target.id.split('_');\n        this.reactive.dispatch('addItem', parts[1], parts[2]);\n    }\n\n    updateInputs() {\n        let jsonElement = this.getElement('#id_metadata_json');\n        const data = metadata.jsonToState(jsonElement.value);\n        jsonElement.value = JSON.stringify(data, metadata.replacer, 4);\n        this.reactive.dispatch('updateFromJson', data);\n    }\n}"],"names":["BaseComponent","create","name","selectors","METADATACONTAINER","UPDATEJSON","UPDATEINPUTS","ADDITEM","container","this","target","element","document","querySelector","reactive","metadata","state","reloadContainerComponent","getWatchers","watch","handler","createDataElement","required","id","tag","value","wrapperid","data","creator","contributor","language","license","isPartOf","scope","options","JSON","parse","stringify","lib","licenses","selectedLicense","selectedOption","find","op","selected","push","text","tags","ajax","placeholder","noselectionstring","showsuggestions","casesensitive","forEach","lang","firstname","firstName","lastname","lastName","institution","year","scopeHolder","additional","property","qualifier","current","firstProp","properties","input","json","replacer","attributes","metadataContainer","getElement","Error","renderComponent","addEventListener","update","addButtons","getElements","addButton","addItem","updateInputs","requiredElements","isError","classList","contains","inputElements","Array","from","map","el","scopeElements","filter","split","propertyElements","currentScope","i","length","scopeMatch","dispatch","event","parts","jsonElement","jsonToState"],"mappings":"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"}