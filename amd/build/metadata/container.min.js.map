{"version":3,"file":"container.min.js","sources":["../../src/metadata/container.js"],"sourcesContent":["// This file is part of Stack - http://stack.maths.ed.ac.uk/\n//\n// Stack is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Stack is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Stack.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main STACK metadata component\n *\n * @module     qtype_stack/metadata\n * @copyright  2025 University of Edinburgh\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later.\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport {metadata} from 'qtype_stack/metadata/metadata';\nimport {notifyFieldValidationFailure} from 'core_form/events';\n\nexport default class extends BaseComponent {\n    create() {\n        this.name = 'stack-metadata-container';\n        this.selectors = {\n            METADATACONTAINER: `[data-for='qtype-stack-metadata']`,\n            UPDATEJSON: `#stack-metadata-update`,\n            UPDATEINPUTS: `#stack-metadata-update-inputs`,\n            ADDCONTRIB: `#stack-metadata-add-contrib`,\n        };\n    }\n\n    /**\n     * Static method to create a component instance form the mustache template.\n     *\n     * @param {string} target the DOM main element or its ID\n     * @param {object} selectors optional css selector overrides\n     * @return {Component}\n     */\n    static init(target, selectors) {\n        return new this({\n            element: document.querySelector(target),\n            reactive: metadata,\n            selectors,\n        });\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * @param {object} state the initial state\n     */\n    async stateReady(state) {\n        await this.reloadContainerComponent({state});\n    }\n\n    getWatchers() {\n        return [\n            {watch: `state:updated`, handler: this.reloadContainerComponent},\n        ];\n    }\n\n    createDataElement(required, id, tag, value) {\n        return {\n            required: required,\n            element: {\n                value: value,\n                wrapperid: 'fitem_smdi_' + id + '_' + tag,\n                id: 'smdi_' + id + '_' + tag,\n                name: 'smdi_' + id + '_' + tag,\n            }\n        };\n    }\n\n    async reloadContainerComponent({state}) {\n        // Mustache data is not fully compatible with state object so we need to convert it\n        // into a plain object.\n        const data = {\n            creator: {},\n            contributor: [],\n            language: [],\n            license: state.license,\n            isPartOf: state.isPartOf,\n            scope: []\n        };\n        state.contributor.forEach(contributor => {\n            const element = {\n                firstname: this.createDataElement(false, contributor.id, 'contributor_firstName', contributor.firstName),\n                lastname: this.createDataElement(true, contributor.id, 'contributor_lastName', contributor.lastName),\n                institution: this.createDataElement(false, contributor.id, 'contributor_institution', contributor.institution),\n                year: this.createDataElement(false, contributor.id, 'contributor_year', contributor.year),\n                id: contributor.id,\n            };\n            data.contributor.push({...element});\n        });\n        state.language.forEach(language => {\n            data.language.push({...language});\n        });\n        const scopeHolder = {};\n        state.additional.forEach(additional => {\n            const element = {\n                property: this.createDataElement(true, additional.id, 'additional_property', additional.property),\n                qualifier: this.createDataElement(false, additional.id, 'additional_qualifier', additional.qualifier),\n                value: this.createDataElement(false, additional.id, 'additional_value', additional.value),\n                id: additional.id,\n            };\n            if (!scopeHolder[additional.scope]) {\n                scopeHolder[additional.scope] = [];\n            }\n            scopeHolder[additional.scope].push(element);\n        });\n        for (const scope in scopeHolder) {\n            const current = { name: scope, properties: scopeHolder[scope], input: this.createDataElement(true, scope, 'additional_scope', scope)};\n            data.scope.push(current);\n        }\n        data.creator = {\n            firstname: this.createDataElement(false, 0, 'creator_firstName', state.creator.firstName),\n            lastname: this.createDataElement(true, 0, 'creator_lastName', state.creator.lastName),\n            institution: this.createDataElement(false, 0, 'creator_institution', state.creator.institution),\n            year: this.createDataElement(false, 0, 'creator_year', state.creator.year),\n        };\n        data.json = {\n            required: true,\n            element: {\n                value: JSON.stringify(state, this.replacer, 4),\n                attributes: 'rows=\"10\"',\n                wrapperid: 'fitem_metadata_json',\n                id: 'id_metadata_json',\n                name: 'metadata_json',\n            }\n        };\n        console.log(data);\n\n        // To render a child component we need a container.\n        const metadataContainer = this.getElement(this.selectors.METADATACONTAINER);\n        if (!metadataContainer) {\n            throw new Error('Missing metadata container.');\n        }\n\n        await this.renderComponent(metadataContainer, 'qtype_stack/metadatacontent', data);\n        this.addEventListener(\n            this.getElement(this.selectors.UPDATEJSON),\n            'click',\n            this.update\n        );\n        this.addEventListener(\n            this.getElement(this.selectors.ADDCONTRIB),\n            'click',\n            this.addContrib\n        );\n        this.addEventListener(\n            this.getElement(this.selectors.UPDATEINPUTS),\n            'click',\n            this.updateInputs\n        );\n    }\n\n    replacer(key, value) {\n        const languages = [];\n        switch(key) {\n            case 'id':\n                return undefined;\n            case 'language':\n                for (const lang of value) {\n                    languages.push(lang.id);\n                }\n                return languages;\n            case 'license':\n            case 'isPartOf':\n                return value.value;\n            default:\n                return value;\n        }\n\n    }\n\n    reviver(key, value) {\n        const holder = [];\n        let id = 1;\n        switch(key) {\n            case 'contributor':\n            case 'additional':\n                for (const current of value) {\n                    current.id = id;\n                    holder.push(current);\n                    id++;\n                }\n                return holder;\n            case 'language':\n                for (const lang of value) {\n                    holder.push({id: lang});\n                }\n                return holder;\n            case 'license':\n            case 'isPartOf':\n                return {value: value};\n            default:\n                return value;\n        }\n\n    }\n\n    /**\n     * Our submit handler.\n     *\n     * @param {Event} event the click event\n     */\n    update(event) {\n        // We don't want to submit the form.\n        event.preventDefault();\n        const requiredElements = this.getElements('#qtype-stack-metadata-content input[aria-required=\"true\"]');\n        for (const element of requiredElements) {\n            if (element.value === '') {\n                notifyFieldValidationFailure(element, 'Required');\n            } else if (element.classList.contains('is-invalid')) {\n                notifyFieldValidationFailure(element, '');\n            }\n        }\n        let inputElements = this.getElements('#qtype-stack-metadata-content input[id^=\"smdi\"]');\n        inputElements = Array.from(inputElements).map((el) => [el.id, el.value]);\n        this.reactive.dispatch('updateAll', inputElements);\n    }\n\n    addContrib() {\n        this.reactive.dispatch('addContributor');\n    }\n\n    updateInputs() {\n        const data = JSON.parse(this.getElement('#id_metadata_json').value, this.reviver);\n        console.log(data);\n        this.reactive.dispatch('updateFromJson', data);\n    }\n}"],"names":["BaseComponent","create","name","selectors","METADATACONTAINER","UPDATEJSON","UPDATEINPUTS","ADDCONTRIB","target","this","element","document","querySelector","reactive","metadata","state","reloadContainerComponent","getWatchers","watch","handler","createDataElement","required","id","tag","value","wrapperid","data","creator","contributor","language","license","isPartOf","scope","forEach","firstname","firstName","lastname","lastName","institution","year","push","scopeHolder","additional","property","qualifier","current","properties","input","json","JSON","stringify","replacer","attributes","console","log","metadataContainer","getElement","Error","renderComponent","addEventListener","update","addContrib","updateInputs","key","languages","lang","reviver","holder","event","preventDefault","requiredElements","getElements","classList","contains","inputElements","Array","from","map","el","dispatch","parse"],"mappings":"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"}